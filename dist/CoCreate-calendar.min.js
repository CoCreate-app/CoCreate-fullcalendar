/* CoCreateJS */
var calOBJs=[],calendarElClass="cal-container",randomColors=["#09efc6","#09ef1a","#efec09","#ef8609","#ef6009","#b609ef","#ef0986","#09efec","#ecef09","#09a6ef","#076692","#c0b507","#c04807","#6b07c0","#72aeb5","#69811e","#8d2b23"];function initSocketsForCalendars(){CoCreateSocket.listen("updateDocument",function(e){updateCalendar(e)}),CoCreateSocket.listen("createDocument",function(e){createdDocumentForCalandar(e)}),CoCreateSocket.listen("deleteDocument",function(e){deleteDocumentForCalendar(e)}),CoCreateSocket.listen("readDocumentList",function(e){fetchedCalendarData(e)})}function fetchedCalendarData(e){let t=g_cocreateFilter.getObjectByFilterId(calOBJs,e.element);t&&renderDataToCalendar(t,e)}function initCalendars(e){let t=e||document;if(!t.querySelectorAll)return;let a=t.querySelectorAll("."+calendarElClass);0==a.length&&t!=document&&t.hasAttribute(calendarElClass)&&(a=[t]);for(var n=0;n<a.length;n++){var r=a[n],i=r.id;if(!i)continue;var l=r.getAttribute("data-calendar_id"),d=r.getAttribute("data-dispaly_field");let e=g_cocreateFilter.setFilter(r,"data-calendar_id","calendar");if(e&&!CoCreateUtils.getInitialized(r)){CoCreateUtils.setInitialized(r);var o=new FullCalendar.Calendar(r,{plugins:["interaction","dayGrid","timeGrid","resourceTimeline","timeline","list"],editable:!0,eventResizableFromStart:!0,eventLimit:!0,selectable:!0,selectMirror:!0,height:"parent",nowIndicator:!0,selectMinDistance:100,header:{left:"prev,",center:"title",right:"next"},defaultView:"dayGridMonth",eventClick:function(e){eventClicked(e)},eventResize:function(e){changedEvent(e)},eventDrop:function(e){changedEvent(e)},select:function(e){selectedDates(e)}});o.render();var c={eId:i,calendar_id:l,calendar:o,displayName:d,filter:e};r.addEventListener("changeFilterInput",function(e){eObj.filter.startIndex=0,g_cocreateFilter.fetchData(eObj.filter)}),g_cocreateFilter.fetchData(e),calOBJs.push(c)}}}function renderDataToCalendar(e,t){console.log(t);var a=new Array;t.data.forEach(function(t,n){var r=new Object;r.id=t._id,r.title=getTitle(t,e.displayName),r.textColor="black",r.backgroundColor=getRandomColor(),r.start=t.start_date,r.end=t.end_date,t.start_time&&(r.start+="T"+t.start_time),t.end_time&&(r.end+="T"+t.end_time),t.start_date&&t.end_date&&a.push(r)}),e.calendar.addEventSource(a)}function createdDocumentForCalandar(e){var t=e.collection;if(!e.data)return;let a=e.data;for(var n=0;n<calOBJs.length;n++){var r=calOBJs[n];if(r.filter.collection==t){var i=new Array;if("module_activity"==t&&(!r.data_module_id||a["data-document_id"]==r.data_module_id)||"module_activity"!=t){var l=new Object;l.id=a._id,l.title=getTitle(a,r.displayName),l.textColor="black",l.backgroundColor=getRandomColor(),l.start=a.start_date,l.end=a.end_date,a.start_time&&(l.start+="T"+a.start_time),a.end_time&&(l.end+="T"+a.end_time),a.start_date&&a.end_date&&i.push(l)}r.calendar.addEventSource(i)}}}function getRandomColor(){var e=Math.floor(Math.random()*randomColors.length);return randomColors[e%randomColors.length]}function getTitle(e,t){var a="";return e[t]&&t&&(a=e[t]),a}function getDate(e){var t,a;if(e.inputs)for(var n=0;n<e.inputs.length;n++){var r=e.inputs[n];"start_date"==r.name?t=r.value:"end_date"==r.name&&(a=r.value)}return{startDate:t,endDate:a}}function updateCalendar(e){for(var t=e.collection,a=0;a<calOBJs.length;a++){var n=calOBJs[a];if(n.filter.collection==t){var r=n.calendar.getEventById(e.document_id);if(r){console.log(r);var i=r.start,l=r.end,d=getDateString(i),o=getTimeString(i),c=getDateString(l),s=getTimeString(l);r.backgroundColor,r.textColor;const t=e.data;for(var u in t){if(u==n.displayName){var g=t[u];r.setProp("title",g)}"start_date"==u&&(d=t[u]),"end_date"==u&&(c=t[u]),"start_time"==u&&(o=t[u]),"end_time"==u&&(s=t[u])}r.setStart(d+"T"+o),r.setEnd(c+"T"+s)}}}}function deleteDocumentForCalendar(e){const t=e.document_id;for(var a=0;a<calOBJs.length;a++){var n=calOBJs[a];n.filter.collection==e.collection&&removeEvent(n.calendar,t)}}function removeEvent(e,t){e.getEventById(t).remove()}function eventClicked(e){console.log(e);var t=e.event,a=t.id,n=t._calendar.el,r=(n.id,n.getAttribute("data-collection"));r=r||"module_activity";var i=n.querySelector(".eventLink");i.setAttribute("data-pass_document_id",a),CoCreateLogic.setLinkProcess(i)}function changedEvent(e){var t=e.event,a=getDateString(t.start),n=getDateString(t.end),r=getTimeString(t.start),i=getTimeString(t.end);console.log(a,n),console.log(e);var l=t._calendar.el.id,d=getCalObjById(l);d&&CoCreate.updateDocument({collection:d.filter.collection,element:l,metadata:"",document_id:t.id,data:{start_date:a,end_date:n,start_time:r,end_time:i}})}function getDateString(e){var t=e.getFullYear(),a=e.getMonth()+1,n=e.getDate();return n<10&&(n="0"+n),a<10&&(a="0"+a),t+"-"+a+"-"+n}function getTimeString(e){var t=e.getHours(),a=e.getMinutes();return t<10&&(t="0"+t),a<10&&(a="0"+a),t+":"+a}function getCalObjById(e){for(var t=0;t<calOBJs.length;t++){var a=calOBJs[t];if(e==a.eId)return a}return null}function selectedDates(e){var t=getDateString(e.start),a=getDateString(e.end),n=getTimeString(e.start),r=getTimeString(e.end),i=e.event._calendar.el.id,l=getCalObjById(i);l&&CoCreate.createDocument({collection:l.filter.collection,element:i,metadata:"",data:{organization_id:config.organization_Id,start_date:t,end_date:a,start_time:n,end_time:r}})}function initCalendarButtons(e){let t=e||document;if(t.querySelectorAll){var a=t.querySelectorAll("[data-calendar_id][data-btn_type]");0===a.length&&t!=document&&t.hasAttribute("data-btn_type")&&t.hasAttribute("data-calendar_id")&&(a=[t]);for(var n=0;n<a.length;n++){var r=a[n];CoCreateUtils.getInitialized(r)||(CoCreateUtils.setInitialized(r),r.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("data-btn_type");calendarBtnClicked(this.getAttribute("data-calendar_id"),t)}))}}}function calendarBtnClicked(e,t){if(e)for(var a=0;a<calOBJs.length;a++){var n=calOBJs[a];if(n.eId==e){var r=n.calendar;switch(console.log(t),t){case"dayGridDay":r.changeView("dayGridDay");break;case"dayGridWeek":r.changeView("dayGridWeek");break;case"dayGridMonth":r.changeView("dayGridMonth");break;case"resourceTimelineDay":r.changeView("resourceTimelineDay");break;case"resourceTimelineThreeDays":r.changeView("resourceTimelineThreeDays");break;case"resourceTimelineFiveDays":r.changeView("resourceTimelineFiveDays");break;case"timeGridWeek":r.changeView("timeGridWeek");break;case"timeGridDay":r.changeView("timeGridDay");break;case"listDay":r.changeView("listDay");break;case"listWeek":r.changeView("listWeek");break;case"listMonth":r.changeView("listMonth");break;case"listYear":r.changeView("listYear");break;case"timelineWeek":r.changeView("timelineWeek");break;case"today":r.today()}}}}initSocketsForCalendars(),initCalendars(),initCalendarButtons(),CoCreateInit.register("CoCreateCalendar",window,initCalendars),CoCreateInit.register("CoCreateCalendar_btn",window,initCalendarButtons);